document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("project"),t=document.getElementById("chat-display"),o=document.getElementById("user-input"),a=document.getElementById("send-button"),n=document.getElementById("settings-form"),r=document.getElementById("marketing-file"),l=document.getElementById("sms-file"),s=document.getElementById("marketing-file-status"),i=document.getElementById("sms-file-status"),c=document.getElementById("api-key-modal"),d=document.getElementById("modal-api-key-input"),m=document.getElementById("validate-key-button"),g=document.getElementById("modal-error-message"),u=document.getElementById("clear-project-button"),y=document.getElementById("clear-history-button"),f=document.getElementById("clear-settings-button"),v=document.getElementById("clear-files-button-left"),h=new bootstrap.Modal(c,{backdrop:"static",keyboard:!1});let p="",I="",S=!1,k=null;const E="userApiKey",C="smsGenSettings",b="smsGenProject",x="smsGenHistory",w="smsGenMarketingFileStatus",A="smsGenSmsFileStatus",P="smsGenUserInput",L="BLAKE123",B="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3000":"https://sms-backend-generator.onrender.com",_=`${B}/api/generate`,N=`${B}/api/validate-key`;async function K(e,t){if("DEV_SALT_REPLACE_IN_BUILD"===t&&console.warn("Calculating hash with default development salt."),!e||!t)return console.error("Cannot calculate hash: API key or salt is missing."),null;const o=e+t,a=(new TextEncoder).encode(o),n=await crypto.subtle.digest("SHA-256",a);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")}function T(){g.textContent="",g.style.display="none",d.value="",h.show(),c.addEventListener("shown.bs.modal",(()=>{d.focus()}),{once:!0})}function j(e,o,a=!1){const n=document.createElement("div");"ai"===e?(n.classList.add("message","ai","alert",a?"alert-danger":"alert-info"),n.setAttribute("role","alert")):n.classList.add("message","user"),a&&"ai"!==e&&n.classList.add("error"),n.textContent=o,t.appendChild(n),t.scrollTop=t.scrollHeight,M()}function $(e,t){const o=e.target.files[0],a="marketing"===t?s:i;if(o){const e=new FileReader;e.onload=e=>{const n=e.target.result;"marketing"===t?(p=n,console.log(`Marketing data loaded (${(n.length/1024).toFixed(2)} KB).`)):(I=n,console.log(`SMS data loaded (${(n.length/1024).toFixed(2)} KB).`)),a.textContent=`Loaded: ${o.name}`,a.className="file-status small text-muted loaded",M()},e.onerror=e=>{console.error("File reading error:",e),"marketing"===t?p="":I="",a.textContent=`Error reading ${o.name}`,a.className="file-status small text-danger error",j("ai",`Error reading file ${o.name}`,!0),M()},e.readAsText(o)}else"marketing"===t?p="":I="",a.textContent="No file selected",a.className="file-status small text-muted",M()}function F(){if(S)return;const r=o.value.trim();if(!r)return;if(!k)return j("ai","Error: API Key not set or validated. Please enter your key.",!0),void T();j("user",r),o.value="",D(),M();!async function(e,o){if(!k)return j("ai","Internal Error: API Key missing before sending request.",!0),void T();S=!0,a.disabled=!0,a.title="Generating...";const n=document.createElement("div");n.classList.add("message","ai","alert","alert-secondary"),n.setAttribute("role","status"),n.innerHTML='\n            <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>\n            <span class="ms-2">Generating...</span>',t.appendChild(n),t.scrollTop=t.scrollHeight;try{const r=await K(k,L);if(!r)return j("ai","Configuration error (salt). Cannot generate signature.",!0),S=!1,a.disabled=!1,void t.removeChild(n);console.log("Sending request to backend:",_);const l=await fetch(_,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":k,"X-Frontend-Secret":r},body:JSON.stringify({userPrompt:e,settings:o,marketingData:p,smsData:I})});if(t.removeChild(n),!l.ok){let e=`Error: ${l.status} ${l.statusText}`;try{const t=await l.json();t&&t.error&&(401===l.status?(e="Error: Invalid or unauthorized API Key. Please refresh the page. If the problem persists, contact the administrator.",localStorage.removeItem(E),k=null,T()):e=403===l.status?`Error: Access Denied. (${t.error||"Please ensure you are accessing from an allowed location."})`:`Error: ${t.error}`)}catch(e){}return console.error("Backend request failed:",e),void j("ai",e,!0)}const s=await l.json();s.text?(console.log("Received response from backend."),j("ai",s.text)):s.error?(console.error("Backend returned an error:",s.error),j("ai",`Error: ${s.error}`,!0)):(console.error("Unexpected response format from backend:",s),j("ai","Received an unexpected response format from the server.",!0))}catch(e){console.error("Network or fetch error:",e);const o=t.querySelector('.alert-secondary[role="status"]');o&&t.removeChild(o),j("ai",`Network error: Could not reach the backend. Is it running? (${e.message})`,!0)}finally{S=!1,a.disabled=!1,a.title="Send Message (Ctrl+Enter)"}}(r,function(){const t=new FormData(n),o={};for(const[e,a]of t.entries()){if("marketing_file"===e||"sms_file"===e||"user_api_key"===e||"modal_api_key_input"===e)continue;const t=n.elements[e];t&&"checkbox"===t.type?o[e]=t.checked:a&&(o[e]=a)}return o.project=e.value,o}())}function M(){try{const a={};new FormData(n).forEach(((e,t)=>{if("marketing_file"===t||"sms_file"===t)return;const o=n.elements[t];o&&("checkbox"===o.type?a[t]=o.checked:a[t]=e)})),localStorage.setItem(C,JSON.stringify(a)),localStorage.setItem(b,e.value),localStorage.setItem(x,t.innerHTML),localStorage.setItem(w,s.textContent),localStorage.setItem(A,i.textContent),localStorage.setItem(w+"_class",s.className),localStorage.setItem(A+"_class",i.className),localStorage.setItem(P,o.value)}catch(e){console.error("Error saving state to localStorage:",e),j("ai","Warning: Could not save application state. LocalStorage might be full or disabled.",!0)}}function D(){o.style.height="auto";const e=o.scrollHeight;o.style.height=e+"px"}console.log("Using Backend Base URL:",B),a.addEventListener("click",F),n.addEventListener("input",M),e.addEventListener("change",M),o.addEventListener("input",(()=>{D(),M()})),u.addEventListener("click",(function(){e.selectedIndex=0,localStorage.removeItem(b),console.log("Project selection cleared."),M()})),y.addEventListener("click",(function(){const e=t.querySelector(".message.ai.alert-info");if(t.innerHTML="",e&&e.textContent.includes("Welcome!"))t.appendChild(e);else{const e=document.createElement("div");e.classList.add("message","ai","alert","alert-info"),e.setAttribute("role","alert"),e.textContent="Welcome! Ask me to generate SMS copy, or use the settings on the right and type your request below. Upload files via the settings panel.",t.appendChild(e)}localStorage.removeItem(x),console.log("Chat history cleared."),M()})),f.addEventListener("click",(function(){n.reset();const e=document.getElementById("use-emojis");e&&(e.checked=!0);const t=document.getElementById("num-results");t&&(t.value=1);localStorage.removeItem(C),console.log("Settings cleared."),M()})),v.addEventListener("click",(function(){r.value="",l.value="",s.textContent="No file selected",s.className="file-status small text-muted",i.textContent="No file selected",i.className="file-status small text-muted",localStorage.removeItem(w),localStorage.removeItem(w+"_class"),localStorage.removeItem(A),localStorage.removeItem(A+"_class"),p="",I="",console.log("File selections cleared."),M()})),o.addEventListener("keydown",(e=>{!e.ctrlKey&&!e.metaKey||"Enter"!==e.key||e.shiftKey||e.altKey||(e.preventDefault(),F())})),r.addEventListener("change",(e=>$(e,"marketing"))),l.addEventListener("change",(e=>$(e,"sms"))),o.addEventListener("input",D),m.addEventListener("click",(async function(){const e=d.value.trim();if(!e)return g.textContent="Please enter an API key.",void(g.style.display="block");g.textContent="Validating...",g.style.display="block",m.disabled=!0;try{const t=await K(e,L);if(!t)return g.textContent="Configuration error (salt). Cannot validate key.",g.style.display="block",void(m.disabled=!1);const o=await fetch(N,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":e,"X-Frontend-Secret":t}});if(o.ok)localStorage.setItem(E,e),k=e,g.textContent="",g.style.display="none",console.log("API Key validated and saved."),h.hide(),j("ai","API Key validated and saved successfully.");else{if(403===o.status)g.textContent="Access Denied. Please ensure you are accessing from an allowed location and the key is correct.";else if(401===o.status)g.textContent="Invalid API Key provided.";else{const e=await o.json().catch((()=>({})));g.textContent=`Validation Error: ${e.error||o.statusText}`}g.style.display="block",console.warn("API Key validation failed:",o.status)}}catch(e){console.error("Error validating API key:",e),g.textContent="Network error during validation. Please try again.",g.style.display="block"}finally{m.disabled=!1}})),async function(){if(function(){try{const a=localStorage.getItem(C);if(a){const e=JSON.parse(a);Object.keys(e).forEach((t=>{const o=n.elements[t];o&&("checkbox"===o.type?o.checked=e[t]:o.value=e[t])}))}const r=localStorage.getItem(b);r&&(e.value=r);const l=localStorage.getItem(x);if(l)t.innerHTML=l,t.scrollTop=t.scrollHeight;else if(!t.querySelector(".message")){const e=document.createElement("div");e.classList.add("message","ai","alert","alert-info"),e.setAttribute("role","alert"),e.textContent="Welcome! Ask me to generate SMS copy, or use the settings on the right and type your request below. Upload files via the settings panel.",t.appendChild(e)}const c=localStorage.getItem(w),d=localStorage.getItem(w+"_class");c&&(s.textContent=c,s.className=d||"file-status small text-muted");const m=localStorage.getItem(A),g=localStorage.getItem(A+"_class");m&&(i.textContent=m,i.className=g||"file-status small text-muted"),p="",I="";const u=localStorage.getItem(P);u&&(o.value=u,D()),console.log("State loaded from localStorage.")}catch(e){console.error("Error loading state from localStorage:",e),j("ai","Warning: Could not load saved application state.",!0),localStorage.removeItem(C),localStorage.removeItem(b),localStorage.removeItem(x),localStorage.removeItem(w),localStorage.removeItem(w+"_class"),localStorage.removeItem(A),localStorage.removeItem(A+"_class"),localStorage.removeItem(P)}}(),k=localStorage.getItem(E),k){console.log("Found API key in localStorage. Validating...");try{const e=await K(k,L);if(e){(await fetch(N,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":k,"X-Frontend-Secret":e}})).ok?console.log("Stored API key is still valid."):(console.warn("Stored API key is no longer valid. Clearing and showing modal."),localStorage.removeItem(E),k=null,T(),j("ai","Your saved API key is no longer valid. Please re-enter it.",!0))}else console.error("Initialization Error: Could not generate hash for validation."),T()}catch(e){console.error("Error validating stored API key during initialization:",e),localStorage.removeItem(E),k=null,T(),j("ai","Could not verify saved API key due to a network issue. Please re-enter it.",!0)}}else console.log("No API key found in localStorage. Showing modal."),T();D()}()}));