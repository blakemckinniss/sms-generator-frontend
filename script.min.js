document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("project"),t=document.getElementById("chat-display"),o=document.getElementById("user-input"),a=document.getElementById("send-button"),n=document.getElementById("settings-form"),r=document.getElementById("marketing-file"),l=document.getElementById("sms-file"),s=document.getElementById("marketing-file-status"),i=document.getElementById("sms-file-status"),c=document.getElementById("api-key-modal"),d=document.getElementById("modal-api-key-input"),m=document.getElementById("validate-key-button"),u=document.getElementById("modal-error-message"),g=document.getElementById("clear-project-button"),y=document.getElementById("clear-history-button"),f=document.getElementById("clear-settings-button"),v=document.getElementById("clear-files-button-left"),p=new bootstrap.Modal(c,{backdrop:"static",keyboard:!1});let h="",I="",S=!1,E=null;const k="userApiKey",C="smsGenSettings",b="smsGenProject",x="smsGenHistory",A="smsGenMarketingFileStatus",L="smsGenSmsFileStatus",w="smsGenUserInput";var _="undefined"!=typeof YOUR_UNIQUE_SECRET_SALT_VALUE_HERE?YOUR_UNIQUE_SECRET_SALT_VALUE_HERE:"DEV_SALT_FALLBACK";const P="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3000":"https://sms-generator-backend-service.onrender.com",B=`${P}/api/generate`,T=`${P}/api/validate-key`;async function N(e,t){if("DEV_SALT_REPLACE_IN_BUILD"===t&&console.warn("Calculating hash with default development salt."),!e||!t)return console.error("Cannot calculate hash: API key or salt is missing."),null;const o=e+t,a=(new TextEncoder).encode(o),n=await crypto.subtle.digest("SHA-256",a);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")}function K(){u.textContent="",u.style.display="none",d.value="",p.show(),c.addEventListener("shown.bs.modal",(()=>{d.focus()}),{once:!0})}function U(e,o,a=!1){const n=document.createElement("div");"ai"===e?(n.classList.add("message","ai","alert",a?"alert-danger":"alert-info"),n.setAttribute("role","alert")):n.classList.add("message","user"),a&&"ai"!==e&&n.classList.add("error"),n.textContent=o,t.appendChild(n),t.scrollTop=t.scrollHeight,$()}function j(e,t){const o=e.target.files[0],a="marketing"===t?s:i;if(o){const e=new FileReader;e.onload=e=>{const n=e.target.result;"marketing"===t?(h=n,console.log(`Marketing data loaded (${(n.length/1024).toFixed(2)} KB).`)):(I=n,console.log(`SMS data loaded (${(n.length/1024).toFixed(2)} KB).`)),a.textContent=`Loaded: ${o.name}`,a.className="file-status small text-muted loaded",$()},e.onerror=e=>{console.error("File reading error:",e),"marketing"===t?h="":I="",a.textContent=`Error reading ${o.name}`,a.className="file-status small text-danger error",U("ai",`Error reading file ${o.name}`,!0),$()},e.readAsText(o)}else"marketing"===t?h="":I="",a.textContent="No file selected",a.className="file-status small text-muted",$()}function F(){if(S)return;const r=o.value.trim();if(!r)return;if(!E)return U("ai","Error: API Key not set or validated. Please enter your key.",!0),void K();U("user",r),o.value="",D(),$();!async function(e,o){if(!E)return U("ai","Internal Error: API Key missing before sending request.",!0),void K();S=!0,a.disabled=!0,a.title="Generating...";const n=document.createElement("div");n.classList.add("message","ai","alert","alert-secondary"),n.setAttribute("role","status"),n.innerHTML='\n            <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>\n            <span class="ms-2">Generating...</span>',t.appendChild(n),t.scrollTop=t.scrollHeight;try{const r=await N(E,_);if(!r)return U("ai","Configuration error (salt). Cannot generate signature.",!0),S=!1,a.disabled=!1,void t.removeChild(n);console.log("Sending request to backend:",B);const l=await fetch(B,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":E,"X-Frontend-Secret":r},body:JSON.stringify({userPrompt:e,settings:o,marketingData:h,smsData:I})});if(t.removeChild(n),!l.ok){let e=`Error: ${l.status} ${l.statusText}`;try{const t=await l.json();t&&t.error&&(401===l.status?(e="Error: Invalid or unauthorized API Key. Please refresh the page. If the problem persists, contact the administrator.",localStorage.removeItem(k),E=null,K()):e=403===l.status?`Error: Access Denied. (${t.error||"Please ensure you are accessing from an allowed location."})`:`Error: ${t.error}`)}catch(e){}return console.error("Backend request failed:",e),void U("ai",e,!0)}const s=await l.json();s.text?(console.log("Received response from backend."),U("ai",s.text)):s.error?(console.error("Backend returned an error:",s.error),U("ai",`Error: ${s.error}`,!0)):(console.error("Unexpected response format from backend:",s),U("ai","Received an unexpected response format from the server.",!0))}catch(e){console.error("Network or fetch error:",e);const o=t.querySelector('.alert-secondary[role="status"]');o&&t.removeChild(o),U("ai",`Network error: Could not reach the backend. Is it running? (${e.message})`,!0)}finally{S=!1,a.disabled=!1,a.title="Send Message (Ctrl+Enter)"}}(r,function(){const t=new FormData(n),o={};for(const[e,a]of t.entries()){if("marketing_file"===e||"sms_file"===e||"user_api_key"===e||"modal_api_key_input"===e)continue;const t=n.elements[e];t&&"checkbox"===t.type?o[e]=t.checked:a&&(o[e]=a)}return o.project=e.value,o}())}function $(){try{const a={};new FormData(n).forEach(((e,t)=>{if("marketing_file"===t||"sms_file"===t)return;const o=n.elements[t];o&&("checkbox"===o.type?a[t]=o.checked:a[t]=e)})),localStorage.setItem(C,JSON.stringify(a)),localStorage.setItem(b,e.value),localStorage.setItem(x,t.innerHTML),localStorage.setItem(A,s.textContent),localStorage.setItem(L,i.textContent),localStorage.setItem(A+"_class",s.className),localStorage.setItem(L+"_class",i.className),localStorage.setItem(w,o.value)}catch(e){console.error("Error saving state to localStorage:",e),U("ai","Warning: Could not save application state. LocalStorage might be full or disabled.",!0)}}function D(){o.style.height="auto";const e=o.scrollHeight;o.style.height=e+"px"}console.log("Using Backend Base URL:",P),"DEV_SALT_REPLACE_IN_BUILD"===_&&console.warn("Running with default development salt. Ensure build process runs for production."),a.addEventListener("click",F),n.addEventListener("input",$),e.addEventListener("change",$),o.addEventListener("input",(()=>{D(),$()})),g.addEventListener("click",(function(){e.selectedIndex=0,localStorage.removeItem(b),console.log("Project selection cleared."),$()})),y.addEventListener("click",(function(){const e=t.querySelector(".message.ai.alert-info");if(t.innerHTML="",e&&e.textContent.includes("Welcome!"))t.appendChild(e);else{const e=document.createElement("div");e.classList.add("message","ai","alert","alert-info"),e.setAttribute("role","alert"),e.textContent="Welcome! Ask me to generate SMS copy, or use the settings on the right and type your request below. Upload files via the settings panel.",t.appendChild(e)}localStorage.removeItem(x),console.log("Chat history cleared."),$()})),f.addEventListener("click",(function(){n.reset();const e=document.getElementById("use-emojis");e&&(e.checked=!0);const t=document.getElementById("num-results");t&&(t.value=1);localStorage.removeItem(C),console.log("Settings cleared."),$()})),v.addEventListener("click",(function(){r.value="",l.value="",s.textContent="No file selected",s.className="file-status small text-muted",i.textContent="No file selected",i.className="file-status small text-muted",localStorage.removeItem(A),localStorage.removeItem(A+"_class"),localStorage.removeItem(L),localStorage.removeItem(L+"_class"),h="",I="",console.log("File selections cleared."),$()})),o.addEventListener("keydown",(e=>{!e.ctrlKey&&!e.metaKey||"Enter"!==e.key||e.shiftKey||e.altKey||(e.preventDefault(),F())})),r.addEventListener("change",(e=>j(e,"marketing"))),l.addEventListener("change",(e=>j(e,"sms"))),o.addEventListener("input",D),m.addEventListener("click",(async function(){const e=d.value.trim();if(!e)return u.textContent="Please enter an API key.",void(u.style.display="block");u.textContent="Validating...",u.style.display="block",m.disabled=!0;try{const t=await N(e,_);if(!t)return u.textContent="Configuration error (salt). Cannot validate key.",u.style.display="block",void(m.disabled=!1);const o=await fetch(T,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":e,"X-Frontend-Secret":t}});if(o.ok)localStorage.setItem(k,e),E=e,u.textContent="",u.style.display="none",console.log("API Key validated and saved."),p.hide(),U("ai","API Key validated and saved successfully.");else{if(403===o.status)u.textContent="Access Denied. Please ensure you are accessing from an allowed location and the key is correct.";else if(401===o.status)u.textContent="Invalid API Key provided.";else{const e=await o.json().catch((()=>({})));u.textContent=`Validation Error: ${e.error||o.statusText}`}u.style.display="block",console.warn("API Key validation failed:",o.status)}}catch(e){console.error("Error validating API key:",e),u.textContent="Network error during validation. Please try again.",u.style.display="block"}finally{m.disabled=!1}})),async function(){if(function(){try{const a=localStorage.getItem(C);if(a){const e=JSON.parse(a);Object.keys(e).forEach((t=>{const o=n.elements[t];o&&("checkbox"===o.type?o.checked=e[t]:o.value=e[t])}))}const r=localStorage.getItem(b);r&&(e.value=r);const l=localStorage.getItem(x);if(l)t.innerHTML=l,t.scrollTop=t.scrollHeight;else if(!t.querySelector(".message")){const e=document.createElement("div");e.classList.add("message","ai","alert","alert-info"),e.setAttribute("role","alert"),e.textContent="Welcome! Ask me to generate SMS copy, or use the settings on the right and type your request below. Upload files via the settings panel.",t.appendChild(e)}const c=localStorage.getItem(A),d=localStorage.getItem(A+"_class");c&&(s.textContent=c,s.className=d||"file-status small text-muted");const m=localStorage.getItem(L),u=localStorage.getItem(L+"_class");m&&(i.textContent=m,i.className=u||"file-status small text-muted"),h="",I="";const g=localStorage.getItem(w);g&&(o.value=g,D()),console.log("State loaded from localStorage.")}catch(e){console.error("Error loading state from localStorage:",e),U("ai","Warning: Could not load saved application state.",!0),localStorage.removeItem(C),localStorage.removeItem(b),localStorage.removeItem(x),localStorage.removeItem(A),localStorage.removeItem(A+"_class"),localStorage.removeItem(L),localStorage.removeItem(L+"_class"),localStorage.removeItem(w)}}(),E=localStorage.getItem(k),E){console.log("Found API key in localStorage. Validating...");try{const e=await N(E,_);if(e){(await fetch(T,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":E,"X-Frontend-Secret":e}})).ok?console.log("Stored API key is still valid."):(console.warn("Stored API key is no longer valid. Clearing and showing modal."),localStorage.removeItem(k),E=null,K(),U("ai","Your saved API key is no longer valid. Please re-enter it.",!0))}else console.error("Initialization Error: Could not generate hash for validation."),K()}catch(e){console.error("Error validating stored API key during initialization:",e),localStorage.removeItem(k),E=null,K(),U("ai","Could not verify saved API key due to a network issue. Please re-enter it.",!0)}}else console.log("No API key found in localStorage. Showing modal."),K();D()}()}));