document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("project"),t=document.getElementById("sms-chat-area"),n=document.getElementById("email-chat-area"),o=document.getElementById("sms-chat-display"),s=document.getElementById("email-chat-display"),a=document.getElementById("sms-user-input"),l=document.getElementById("email-user-input"),r=document.getElementById("sms-send-button"),i=document.getElementById("email-send-button"),c=document.getElementById("settings-form"),d=document.getElementById("marketing-file"),m=document.getElementById("sms-file"),u=document.getElementById("marketing-file-status"),g=document.getElementById("sms-file-status"),f=document.getElementById("api-key-modal"),y=document.getElementById("modal-api-key-input"),v=document.getElementById("validate-key-button"),p=document.getElementById("modal-error-message"),h=document.getElementById("clear-project-button"),E=document.getElementById("clear-sms-history-button"),I=document.getElementById("clear-email-history-button"),b=document.getElementById("clear-settings-button"),L=document.getElementById("clear-files-button-left"),S=document.getElementById("length"),k=document.getElementById("num-results"),x=document.getElementById("download-sms-history-button"),C=document.getElementById("download-email-history-button"),w=document.getElementById("mode-sms"),$=document.getElementById("mode-email"),B=document.getElementById("email-subject"),N=document.getElementById("email-message"),A=(document.querySelector(".mode-selector"),new bootstrap.Modal(f,{backdrop:"static",keyboard:!1}));let T="",j="",_=!1,P=null,M={},H="sms";const D="userApiKey",K="smsGenProject",U="smsGenMode",R="smsGenHistory_",O="smsGenMarketingFileStatus",F="smsGenSmsFileStatus",q="smsGenUserInput_",G="BLAKE123",V="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3000":"https://sms-backend-generator.onrender.com",z=`${V}/api/generate`,J=`${V}/api/validate-key`;console.log("Using Backend Base URL:",V);const W='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>';async function X(e,t){if("DEV_SALT_REPLACE_IN_BUILD"===t&&console.warn("Calculating hash with default development salt."),!e||!t)return console.error("Cannot calculate hash: API key or salt is missing."),null;const n=e+t,o=(new TextEncoder).encode(n),s=await crypto.subtle.digest("SHA-256",o);return Array.from(new Uint8Array(s)).map((e=>e.toString(16).padStart(2,"0"))).join("")}function Q(){p.textContent="",p.style.display="none",y.value="",A.show(),f.addEventListener("shown.bs.modal",(()=>y.focus()),{once:!0})}function Y(){A.hide()}async function Z(){const e=y.value.trim();if(!e)return p.textContent="Please enter an API key.",void(p.style.display="block");const t=e.toUpperCase();if("DEBUG"===t)return console.log("DEBUG keyword entered. Hiding modal."),void Y();p.textContent="Validating...",p.style.display="block",v.disabled=!0;try{const e=await X(t,G);if(!e)return p.textContent="Configuration error (salt). Cannot validate key.",p.style.display="block",void(v.disabled=!1);const n=await fetch(J,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":t,"X-Frontend-Secret":e}});if(n.ok)localStorage.setItem(D,t),P=t,p.textContent="",p.style.display="none",console.log("API Key validated and saved (uppercase)."),Y(),ne("ai","API Key validated and saved successfully.");else{if(403===n.status)p.textContent="Access Denied. Please ensure you are accessing from an allowed location and the key is correct.";else if(401===n.status)p.textContent="Invalid API Key provided.";else{const e=await n.json().catch((()=>({})));p.textContent=`Validation Error: ${e.error||n.statusText}`}p.style.display="block",console.warn("API Key validation failed:",n.status)}}catch(e){console.error("Error validating API key:",e),p.textContent="Network error during validation. Please try again.",p.style.display="block"}finally{v.disabled=!1}}function ee(e){if(e===H)return;console.log(`Switching mode from ${H} to ${e}`);const r=`${R}${H}`,i=`${q}${H}`,c=`${R}${e}`,d=`${q}${e}`,m="sms"===H?o:s,u="sms"===H?a:l;localStorage.setItem(r,m.innerHTML),localStorage.setItem(i,u.value),H=e,"sms"===H?(t.classList.remove("d-none"),t.classList.add("d-flex"),n.classList.add("d-none"),n.classList.remove("d-flex")):(n.classList.remove("d-none"),n.classList.add("d-flex"),t.classList.add("d-none"),t.classList.remove("d-flex")),document.body.classList.remove("mode-sms-active","mode-email-active"),document.body.classList.add(`mode-${H}-active`);const g="sms"===H?o:s,f="sms"===H?a:l,y=localStorage.getItem(c);y?g.innerHTML=y:(g.innerHTML="",te(g,H)),g.scrollTop=g.scrollHeight;const v=localStorage.getItem(d);f.value=v||"",de(f),localStorage.setItem(U,H),re(),ce(),console.log(`Mode switched to ${H}. State loaded/saved.`)}function te(e,t){const n=document.createElement("div");n.classList.add("message","ai","alert","alert-info"),n.setAttribute("role","alert"),n.textContent=`Welcome to ${"sms"===t?"SMS":"Email"} mode! Select a project and type your request below, or use the settings on the right.`,e.appendChild(n)}function ne(e,t){const n="sms"===H?o:s;if(!n)return console.error(`addMessageToChat failed: chatDisplay element for mode '${H}' not found!`),void alert("Critical Error: Chat display area is missing. Please reload the page.");const a=document.createElement("div");if(a.classList.add("message",e),"ai"===e){const e="string"==typeof t&&t.startsWith("Error:");a.classList.add("alert",e?"alert-danger":"alert-info"),a.setAttribute("role","alert");let n="",o="";const s=e=>{if("string"!=typeof e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML},l=(e,t=null)=>{const n=e.subject?s(e.subject):"(No Subject Provided)",o=document.createElement("pre");o.className="email-body",o.textContent=e.message||"(No Message Provided)";return`${null!==t?`<strong>Variation ${t+1}:</strong><br>`:""}<strong>Subject:</strong> ${n}<br><hr class='my-1'><strong>Message:</strong><br>${o.outerHTML}`},r=(e,t=null)=>`${null!==t?`Variation ${t+1}:\n`:""}Subject: ${e.subject||"(No Subject Provided)"}\nMessage:\n${e.message||"(No Message Provided)"}`;if(Array.isArray(t))n=t.map(((e,t)=>`<div class='email-variation'>${l(e,t)}</div>`)).join("<hr class='my-2'>"),o=t.map(((e,t)=>r(e,t))).join("\n\n---\n\n");else if("object"==typeof t&&null!==t&&(t.subject||t.message))n=l(t),o=r(t);else{const e="string"==typeof t?t:JSON.stringify(t);n=s(e),o=e}a.innerHTML=n,a.dataset.rawText=o;const i=document.createElement("button");i.type="button",i.classList.add("btn","btn-sm","copy-msg-btn"),i.title="Copy message",i.innerHTML=W,a.appendChild(i)}else{const e="string"==typeof t?t:JSON.stringify(t);a.textContent=e,a.dataset.rawText=e}n.insertAdjacentElement("beforeend",a),n.scrollTop=n.scrollHeight,ae()}function oe(e,t){const n=e.target.files[0],o="marketing"===t?u:g;if(n){const e=new FileReader;e.onload=e=>{const s=e.target.result;"marketing"===t?(T=s,console.log(`Marketing data loaded (${(s.length/1024).toFixed(2)} KB).`)):(j=s,console.log(`SMS data loaded (${(s.length/1024).toFixed(2)} KB).`)),o.textContent=`Loaded: ${n.name}`,o.className="file-status small text-muted loaded",ae()},e.onerror=e=>{console.error("File reading error:",e),"marketing"===t?T="":j="",o.textContent=`Error reading ${n.name}`,o.className="file-status small text-danger error",ne("ai",`Error: Error reading file ${n.name}`),ae()},e.readAsText(n)}else"marketing"===t?T="":j="",o.textContent="No file selected",o.className="file-status small text-muted",ae()}function se(){if(_)return;const t="sms"===H?a:l,n=t.value.trim(),d="email"===H&&(B.value.trim()||N.value.trim());if(!n&&!d)return;if(!P)return ne("ai","Error: API Key not set or validated. Please enter your key."),void Q();n&&ne("user",n),t.value="",de(t),ae();!async function(e,t){if(!P)return ne("ai","Error: Internal Error: API Key missing before sending request."),void Q();const n="sms"===H?o:s,a="sms"===H?r:i;_=!0,a.disabled=!0,a.title="Generating...";const l=document.createElement("div");l.classList.add("message","ai","alert","alert-secondary"),l.setAttribute("role","status"),l.innerHTML='<span class="spinner-border spinner-border-sm" aria-hidden="true"></span><span class="ms-2">Generating...</span>',n.appendChild(l),n.scrollTop=n.scrollHeight;let c=parseInt(t.num_results,10);t.num_results=!isNaN(c)&&c>=1?c:1;try{const o=await X(P,G);if(!o)return ne("ai","Error: Configuration error (salt). Cannot generate signature."),_=!1,a.disabled=!1,void(l.parentNode&&n.removeChild(l));console.log("Sending request to backend:",z),console.log("Settings being sent:",t);const s=await fetch(z,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":P,"X-Frontend-Secret":o},body:JSON.stringify({userPrompt:e,settings:t,marketingData:T,smsData:j})});if(l.parentNode&&n.removeChild(l),!s.ok){let e=`Error: ${s.status} ${s.statusText}`;try{const t=await s.json();t&&t.error&&(401===s.status?(e="Error: Invalid or unauthorized API Key. Please refresh the page. If the problem persists, contact the administrator.",localStorage.removeItem(D),P=null,Q()):e=403===s.status?`Error: Access Denied. (${t.error||"Please ensure you are accessing from an allowed location."})`:`Error: ${t.error}`)}catch(e){}return console.error("Backend request failed:",e),void ne("ai",e)}const r=s.headers.get("content-type");if(r&&r.includes("application/json")){const e=await s.json();e.error?(console.error("Backend returned a JSON error:",e.error),ne("ai",`Error: ${e.error}`)):e?(console.log("Received JSON response from backend."),ne("ai",e)):(console.error("Backend returned empty/invalid JSON response."),ne("ai","Error: Received an unexpected JSON response format from the server."))}else{const e=await s.text();e?(console.log("Received text response from backend."),ne("ai",e)):(console.error("Backend returned empty text response."),ne("ai","Error: Received an empty response from the server."))}}catch(e){console.error("Network or fetch error:",e);const t=n.querySelector('.alert-secondary[role="status"]');t&&t.parentNode&&n.removeChild(t),ne("ai",`Error: Network error: Could not reach the backend. Is it running? (${e.message})`)}finally{_=!1,a.disabled=!1,a.title=`Send ${"sms"===H?"SMS":"Email"} Request (Ctrl+Enter)`}}(n,function(){const t=new FormData(c),n={};n.mode=H;for(const[e,o]of t.entries()){if("marketing_file"===e||"sms_file"===e||"modal_api_key_input"===e||"mode"===e)continue;const t=c.elements[e];if(!t)continue;const s=t.classList&&t.classList.contains("input-active-glow"),a=o&&""!==o.trim();if("sms"===H){if(["length","topic","date","tone","href","num_results"].includes(e))s&&a&&(n[e]=o);else if("use_emojis"===e){const o=!0===M[e];(s||o&&t.checked)&&(n[e]=t.checked)}}else if("email"===H)if(["subject","message","topic","date","tone","href","num_results"].includes(e))s&&a&&(n[e]=o);else if("use_emojis"===e){const o=!0===M[e];(s||o&&t.checked)&&(n[e]=t.checked)}}n.project=e.value,!n.num_results&&k.value&&(n.num_results=k.value);let o=parseInt(n.num_results,10);if(n.num_results=!isNaN(o)&&o>=1?o:1,void 0===n.use_emojis){const e=c.elements.use_emojis;n.use_emojis=!e||e.checked}return n}())}function ae(){try{localStorage.setItem(K,e.value),localStorage.setItem(U,H);const t=`${R}${H}`,n=`${q}${H}`,r="sms"===H?o:s,i="sms"===H?a:l;localStorage.setItem(t,r.innerHTML),localStorage.setItem(n,i.value),localStorage.setItem(O,u.textContent),localStorage.setItem(F,g.textContent),localStorage.setItem(O+"_class",u.className),localStorage.setItem(F+"_class",g.className)}catch(e){console.error("Error saving state to localStorage:",e),ne("ai","Warning: Could not save application state. LocalStorage might be full or disabled.")}}function le(e){const t=`${R}${e}`,n="sms"===e?o:s;n.innerHTML="",te(n,e),localStorage.removeItem(t),console.log(`Chat history cleared for ${e} mode.`),e===H&&ae()}function re(){console.log("Storing default settings values for mode:",H),M={};for(const e of c.elements)if(e&&e.name&&("INPUT"===e.tagName||"SELECT"===e.tagName||"TEXTAREA"===e.tagName)){const t=e.closest(".sms-only"),n=e.closest(".email-only");("sms"===H&&!n||"email"===H&&!t||!t&&!n)&&("checkbox"===e.type?M[e.name]=e.defaultChecked:M[e.name]=e.defaultValue||"")}console.log("Default settings stored:",M)}function ie(e){const t="input-active-glow";if(!e||!e.name||"file"===e.type||"hidden"===e.type||"BUTTON"===e.tagName)return;let n=!0;const o=M[e.name];if(void 0===o)n=!0;else if("checkbox"===e.type)n=e.checked===o;else{n=(e.value||"")===(o||"")}e.classList&&(n?e.classList.remove(t):e.classList.add(t))}function ce(){console.log("Updating glows for all settings inputs based on defaults for mode:",H);for(const e of c.elements)e&&ie(e)}function de(e){if(!e)return;e.style.height="auto";e.style.height=Math.max(40,e.scrollHeight)+"px"}function me(e){const t=new Event("input",{bubbles:!0,cancelable:!0});e.dispatchEvent(t)}function ue(e){const t=e.target.value,n=t.replace(/\D/g,"");t!==n&&(e.target.value=n)}function ge(t){const n=("sms"===t?o:s).querySelectorAll(".message.ai:not(.alert-info):not(.alert-danger)");if(0===n.length)return void ne("ai",`Info: No AI messages to download for ${t.toUpperCase()} mode.`);let a=`AI Generated Content - ${e.value} (${t.toUpperCase()}) - ${(new Date).toLocaleString()}\n\n`;a+="========================================\n\n",n.forEach(((e,t)=>{const n=e.dataset.rawText||e.innerText||e.textContent;a+=`----- Result ${t+1} -----\n`,a+=n.trim(),a+="\n\n========================================\n\n"}));const l=new Blob([a],{type:"text/plain;charset=utf-8"}),r=document.createElement("a"),i=(new Date).toISOString().replace(/[:.]/g,"-");r.href=URL.createObjectURL(l),r.download=`ai_content_${e.value}_${t}_${i}.txt`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(r.href),console.log(`AI history downloaded for ${t} mode.`)}e.addEventListener("change",ae),d.addEventListener("change",(e=>oe(e,"marketing"))),m.addEventListener("change",(e=>oe(e,"sms"))),r.addEventListener("click",se),i.addEventListener("click",se),v.addEventListener("click",Z),y.addEventListener("keydown",(function(e){"Enter"===e.key&&(e.preventDefault(),Z())})),h.addEventListener("click",(function(){e.selectedIndex=0,localStorage.removeItem(K),console.log("Project selection cleared."),ae()})),E.addEventListener("click",(()=>le("sms"))),I.addEventListener("click",(()=>le("email"))),b.addEventListener("click",(function(){c.reset(),console.log("Settings cleared."),ce()})),L.addEventListener("click",(function(){d.value="",m.value="",T="",j="",u.textContent="No file selected",g.textContent="No file selected",u.className="file-status small text-muted",g.className="file-status small text-muted",console.log("File selections, data, and UI status cleared."),ae()})),x.addEventListener("click",(()=>ge("sms"))),C.addEventListener("click",(()=>ge("email"))),w.addEventListener("change",(()=>ee("sms"))),$.addEventListener("change",(()=>ee("email"))),c.addEventListener("input",(e=>{e.target&&e.target.matches("input, textarea, select")&&(ie(e.target),ae())})),c.addEventListener("click",(function(e){const t=e.target.closest(".clear-input-btn");if(!t)return;const n=t.dataset.targetInput;if(!n)return void console.warn("Clear button clicked, but no target input ID found.");const o=document.getElementById(n);if(!o)return void console.warn(`Clear button clicked, but target input '#${n}' not found.`);const s=o.name;if(!s||void 0===M[s])return void console.warn(`Could not find default value for input '${s}'. Cannot reset.`);const a=M[s];"checkbox"===o.type?o.checked=a:o.value=a,me(o),console.log(`Input '${s}' reset to default value:`,a)}));const fe=document.querySelector(".main-content-container");fe?fe.addEventListener("click",(function(e){const t=e.target.closest(".copy-msg-btn");if(!t)return;const n=t.closest(".message.ai");if(!n||!n.dataset.rawText)return void console.error("Could not find message text to copy.");const o=n.dataset.rawText;navigator.clipboard.writeText(o).then((()=>{t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022z"/></svg>',t.classList.add("copied"),t.disabled=!0,setTimeout((()=>{t.innerHTML=W,t.classList.remove("copied"),t.disabled=!1}),1500)})).catch((e=>{console.error("Failed to copy text: ",e),t.title="Copy failed!",setTimeout((()=>{t.title="Copy message"}),2e3)}))})):console.error("Could not find main content container to attach copy listener."),[a,l].forEach((e=>{e&&(e.addEventListener("input",(()=>{de(e),ae()})),e.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),se())})))})),S&&(S.addEventListener("input",ue),S.addEventListener("blur",(function(e){const t=e.target;let n=parseInt(t.value,10);(isNaN(n)||n<=0)&&(t.value="140",me(t))}))),k&&(k.addEventListener("input",ue),k.addEventListener("blur",(function(e){const t=e.target,n=parseInt(t.min,10)||1,o=parseInt(t.max,10)||20;let s=parseInt(t.value,10);(isNaN(s)||s<n||s>o)&&(t.value="1",me(t))}))),async function(){if(console.log("Initializing application..."),P=localStorage.getItem(D),P?console.log("Found API Key in localStorage."):(console.log("API Key not found in localStorage."),Q()),function(){try{const r=localStorage.getItem(K);r&&(e.value=r);const i=localStorage.getItem(O),c=localStorage.getItem(O+"_class");i&&(u.textContent=i,u.className=c||"file-status small text-muted");const d=localStorage.getItem(F),m=localStorage.getItem(F+"_class");d&&(g.textContent=d,g.className=m||"file-status small text-muted"),T="",j="";const f=localStorage.getItem(U);H=f||"sms","email"===H?($.checked=!0,t.classList.add("d-none"),t.classList.remove("d-flex"),n.classList.remove("d-none"),n.classList.add("d-flex")):(w.checked=!0,n.classList.add("d-none"),n.classList.remove("d-flex"),t.classList.remove("d-none"),t.classList.add("d-flex")),document.body.classList.add(`mode-${H}-active`),["sms","email"].forEach((e=>{const t=`${R}${e}`,n=`${q}${e}`,r="sms"===e?o:s,i="sms"===e?a:l,c=localStorage.getItem(t);c?r.innerHTML=c:(r.innerHTML="",te(r,e)),r.scrollTop=r.scrollHeight;const d=localStorage.getItem(n);i.value=d||"",de(i)})),console.log("State loaded from localStorage.")}catch(e){console.error("Error loading state from localStorage:",e),ne("ai","Warning: Could not load saved application state."),localStorage.removeItem(K),localStorage.removeItem(U),localStorage.removeItem(`${R}sms`),localStorage.removeItem(`${R}email`),localStorage.removeItem(O),localStorage.removeItem(O+"_class"),localStorage.removeItem(F),localStorage.removeItem(F+"_class")}}(),document.body.classList.remove("mode-sms-active","mode-email-active"),document.body.classList.add(`mode-${H}-active`),re(),ce(),de(a),de(l),P){const e=chatDisplay.querySelector(".message.ai");if(!e||!e.textContent.startsWith("Welcome to")){const e=chatDisplay.querySelectorAll(".message.ai");let t=!1;e.forEach((e=>{e.textContent.includes("Ready to generate")&&(t=!0)})),!t&&chatDisplay.textContent.includes("API Key validated")}}console.log(`Application initialized in ${H} mode.`)}()}));