document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("project"),t=document.getElementById("chat-display"),o=document.getElementById("user-input"),n=document.getElementById("send-button"),a=document.getElementById("settings-form"),s=document.getElementById("marketing-file"),l=document.getElementById("sms-file"),r=document.getElementById("marketing-file-status"),i=document.getElementById("sms-file-status"),c=document.getElementById("api-key-modal"),d=document.getElementById("modal-api-key-input"),m=document.getElementById("validate-key-button"),u=document.getElementById("modal-error-message"),g=document.getElementById("clear-project-button"),f=document.getElementById("clear-history-button"),p=document.getElementById("clear-settings-button"),v=document.getElementById("clear-files-button-left"),y=document.getElementById("length"),h=document.getElementById("num-results"),b=document.getElementById("download-history-button"),I=document.getElementById("mode-sms"),E=document.getElementById("mode-email"),S=document.getElementById("email-subject"),k=document.getElementById("email-message"),w=document.querySelector(".mode-selector"),C=new bootstrap.Modal(c,{backdrop:"static",keyboard:!1});let L="",x="",$=!1,A=null,T={},N="sms";const j="userApiKey",B="smsGenProject",M="smsGenMode",P="smsGenHistory_",_="smsGenMarketingFileStatus",H="smsGenSmsFileStatus",K="smsGenUserInput",U="BLAKE123",D="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3000":"https://sms-backend-generator.onrender.com",F=`${D}/api/generate`,R=`${D}/api/validate-key`;console.log("Using Backend Base URL:",D);const q='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>';async function G(e,t){if("DEV_SALT_REPLACE_IN_BUILD"===t&&console.warn("Calculating hash with default development salt."),!e||!t)return console.error("Cannot calculate hash: API key or salt is missing."),null;const o=e+t,n=(new TextEncoder).encode(o),a=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(a)).map((e=>e.toString(16).padStart(2,"0"))).join("")}function V(){u.textContent="",u.style.display="none",d.value="",C.show(),c.addEventListener("shown.bs.modal",(()=>d.focus()),{once:!0})}function O(){C.hide()}async function W(){const e=d.value.trim();if(!e)return u.textContent="Please enter an API key.",void(u.style.display="block");const t=e.toUpperCase();if("DEBUG"===t)return console.log("DEBUG keyword entered. Hiding modal."),void O();u.textContent="Validating...",u.style.display="block",m.disabled=!0;try{const e=await G(t,U);if(!e)return u.textContent="Configuration error (salt). Cannot validate key.",u.style.display="block",void(m.disabled=!1);const o=await fetch(R,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":t,"X-Frontend-Secret":e}});if(o.ok)localStorage.setItem(j,t),A=t,u.textContent="",u.style.display="none",console.log("API Key validated and saved (uppercase)."),O(),z("ai","API Key validated and saved successfully.");else{if(403===o.status)u.textContent="Access Denied. Please ensure you are accessing from an allowed location and the key is correct.";else if(401===o.status)u.textContent="Invalid API Key provided.";else{const e=await o.json().catch((()=>({})));u.textContent=`Validation Error: ${e.error||o.statusText}`}u.style.display="block",console.warn("API Key validation failed:",o.status)}}catch(e){console.error("Error validating API key:",e),u.textContent="Network error during validation. Please try again.",u.style.display="block"}finally{m.disabled=!1}}function z(e,o,n=!1){if(!t)return console.error("addMessageToChat failed: chatDisplay element not found!"),void alert("Critical Error: Chat display area is missing. Please reload the page.");const a=document.createElement("div");if(a.classList.add("message",e),"ai"===e){a.classList.add("alert",n?"alert-danger":"alert-info"),a.setAttribute("role","alert");let e="",t="";if("object"==typeof o&&null!==o&&(o.subject||o.message)){const n=o.subject||"(No Subject Provided)",s=o.message||"(No Message Provided)";e=`<strong>Subject:</strong> ${n}<br><hr class='my-1'><strong>Message:</strong><br><pre class='email-body'>${s.replace(/</g,"<").replace(/>/g,">")}</pre>`,t=`Subject: ${n}\nMessage:\n${s}`,a.dataset.rawText=t,a.innerHTML=e}else if(Array.isArray(o))e=o.map(((e,t)=>`<div class='email-variation'><strong>Variation ${t+1}:</strong><br><strong>Subject:</strong> ${e.subject||"(No Subject Provided)"}<br><hr class='my-1'><strong>Message:</strong><br><pre class='email-body'>${(e.message||"(No Message Provided)").replace(/</g,"<").replace(/>/g,">")}</pre></div>`)).join("<hr class='my-2'>"),t=o.map(((e,t)=>`Variation ${t+1}:\nSubject: ${e.subject||"(No Subject Provided)"}\nMessage:\n${e.message||"(No Message Provided)"}`)).join("\n\n---\n\n"),a.dataset.rawText=t,a.innerHTML=e;else{const n="string"==typeof o?o:JSON.stringify(o);e=n,t=n,a.dataset.rawText=t;const s=document.createTextNode(e);a.appendChild(s)}const s=document.createElement("button");s.type="button",s.classList.add("btn","btn-sm","copy-msg-btn"),s.title="Copy message",s.innerHTML=q,a.appendChild(s)}else{const e=document.createTextNode(o);a.appendChild(e),a.dataset.rawText=o}n&&"ai"!==e&&a.classList.add("error"),t.insertAdjacentElement("beforeend",a),t.scrollTop=t.scrollHeight,Q()}function X(e,t){const o=e.target.files[0],n="marketing"===t?r:i;if(o){const e=new FileReader;e.onload=e=>{const a=e.target.result;"marketing"===t?(L=a,console.log(`Marketing data loaded (${(a.length/1024).toFixed(2)} KB).`)):(x=a,console.log(`SMS data loaded (${(a.length/1024).toFixed(2)} KB).`)),n.textContent=`Loaded: ${o.name}`,n.className="file-status small text-muted loaded",Q()},e.onerror=e=>{console.error("File reading error:",e),"marketing"===t?L="":x="",n.textContent=`Error reading ${o.name}`,n.className="file-status small text-danger error",z("ai",`Error reading file ${o.name}`,!0),Q()},e.readAsText(o)}else"marketing"===t?L="":x="",n.textContent="No file selected",n.className="file-status small text-muted",Q()}function J(){if($)return;const s=o.value.trim();if(!s&&"sms"===N)return;if(!s&&"email"===N&&!S.value.trim()&&!k.value.trim())return;if(!A)return z("ai","Error: API Key not set or validated. Please enter your key.",!0),void V();s&&z("user",s),o.value="",te(),Q();!async function(e,o){if(!A)return z("ai","Internal Error: API Key missing before sending request.",!0),void V();$=!0,n.disabled=!0,n.title="Generating...";const a=document.createElement("div");if(a.classList.add("message","ai","alert","alert-secondary"),a.setAttribute("role","status"),a.innerHTML='<span class="spinner-border spinner-border-sm" aria-hidden="true"></span><span class="ms-2">Generating...</span>',t.appendChild(a),t.scrollTop=t.scrollHeight,void 0===o.num_results){const t=e.match(/\d+/);if(t){const e=parseInt(t[0],10);!isNaN(e)&&e>=1&&e<=20?(o.num_results=e,console.log(`Extracted num_results (${e}) from prompt.`)):console.log(`Number found in prompt (${t[0]}) is outside valid range (1-20). Ignoring.`)}}(void 0===o.num_results||o.num_results<1)&&(o.num_results=1);try{const s=await G(A,U);if(!s)return z("ai","Configuration error (salt). Cannot generate signature.",!0),$=!1,n.disabled=!1,void t.removeChild(a);console.log("Sending request to backend:",F),console.log("Settings being sent:",o);const l=await fetch(F,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":A,"X-Frontend-Secret":s},body:JSON.stringify({userPrompt:e,settings:o,marketingData:L,smsData:x})});if(t.removeChild(a),!l.ok){let e=`Error: ${l.status} ${l.statusText}`;try{const t=await l.json();t&&t.error&&(401===l.status?(e="Error: Invalid or unauthorized API Key. Please refresh the page. If the problem persists, contact the administrator.",localStorage.removeItem(j),A=null,V()):e=403===l.status?`Error: Access Denied. (${t.error||"Please ensure you are accessing from an allowed location."})`:`Error: ${t.error}`)}catch(e){}return console.error("Backend request failed:",e),void z("ai",e,!0)}const r=await l.json();r.error?(console.error("Backend returned an error:",r.error),z("ai",`Error: ${r.error}`,!0)):r?(console.log("Received response from backend."),z("ai",r)):(console.error("Unexpected response format from backend:",r),z("ai","Received an unexpected response format from the server.",!0))}catch(e){console.error("Network or fetch error:",e);const o=t.querySelector('.alert-secondary[role="status"]');o&&t.removeChild(o),z("ai",`Network error: Could not reach the backend. Is it running? (${e.message})`,!0)}finally{$=!1,n.disabled=!1,n.title="Send Message (Ctrl+Enter)"}}(s,function(){const t=new FormData(a),o={};o.mode=N;for(const[e,n]of t.entries()){if("marketing_file"===e||"sms_file"===e||"modal_api_key_input"===e||"mode"===e)continue;const t=a.elements[e];if(t)if("sms"===N){if("length"===e||"topic"===e||"date"===e||"tone"===e||"href"===e||"num_results"===e)t.classList.contains("input-active-glow")&&n&&(o[e]=n);else if("use_emojis"===e){const n=!0===T[e];(t.classList.contains("input-active-glow")||n&&t.checked)&&(o[e]=t.checked)}}else if("email"===N)if("subject"===e||"message"===e||"topic"===e||"date"===e||"tone"===e||"href"===e||"num_results"===e)t.classList.contains("input-active-glow")&&n&&(o[e]=n);else if("use_emojis"===e){const n=!0===T[e];(t.classList.contains("input-active-glow")||n&&t.checked)&&(o[e]=t.checked)}}if(o.project=e.value,!o.num_results&&h.value&&(o.num_results=h.value),(void 0===o.num_results||o.num_results<1)&&(o.num_results=1),void 0===o.use_emojis){const e=a.elements.use_emojis;o.use_emojis=!e||e.checked}return o}())}function Q(){try{localStorage.setItem(B,e.value),localStorage.setItem(M,N);const n=`${P}${N}`;localStorage.setItem(n,t.innerHTML),localStorage.setItem(_,r.textContent),localStorage.setItem(H,i.textContent),localStorage.setItem(_+"_class",r.className),localStorage.setItem(H+"_class",i.className),localStorage.setItem(K,o.value)}catch(e){console.error("Error saving state to localStorage:",e),z("ai","Warning: Could not save application state. LocalStorage might be full or disabled.",!0)}}function Y(){console.log("Storing default settings values..."),T={};for(const e of a.elements)if(e.name&&("INPUT"===e.tagName||"SELECT"===e.tagName||"TEXTAREA"===e.tagName)){const t=e.closest(".sms-only"),o=e.closest(".email-only");("sms"===N&&!o||"email"===N&&!t||!t&&!o)&&("checkbox"===e.type?T[e.name]=e.defaultChecked:T[e.name]=e.defaultValue||"")}console.log("Default settings stored:",T)}function Z(e){const t="input-active-glow";if(!e||!e.name||"file"===e.type||"hidden"===e.type||"BUTTON"===e.tagName)return;let o=!0;const n=T[e.name];if(void 0===n)o=!0;else if("checkbox"===e.type)o=e.checked===n;else{o=(e.value||"")===(n||"")}o?e.classList.remove(t):e.classList.add(t)}function ee(){console.log("Updating glows for all settings inputs based on defaults.");for(const e of a.elements)Z(e)}function te(){o.style.height="auto",o.style.height=o.scrollHeight+"px"}function oe(e){const t=new Event("input",{bubbles:!0,cancelable:!0});e.dispatchEvent(t)}function ne(e){const t=e.target.value,o=t.replace(/\D/g,"");t!==o&&(e.target.value=o)}n.addEventListener("click",J),a.addEventListener("input",(e=>{Z(e.target),Q()})),e.addEventListener("change",Q),o.addEventListener("input",(()=>{te(),Q()})),g.addEventListener("click",(function(){e.selectedIndex=0,localStorage.removeItem(B),console.log("Project selection cleared."),Q()})),f.addEventListener("click",(function(){const e=`${P}${N}`;t.innerHTML="";const o=document.createElement("div");o.classList.add("message","ai","alert","alert-info"),o.setAttribute("role","alert"),o.textContent=`Welcome to ${"sms"===N?"SMS":"Email"} mode! Select a project and type your request below, or use the settings on the right.`,t.appendChild(o),localStorage.removeItem(e),console.log(`Chat history cleared for ${N} mode.`),Q()})),p.addEventListener("click",(function(){a.reset(),console.log("Settings cleared."),ee()})),v.addEventListener("click",(function(){s.value="",l.value="",L="",x="",r.textContent="No file selected",i.textContent="No file selected",r.className="file-status small text-muted",i.className="file-status small text-muted",console.log("File selections and data cleared."),Q()})),o.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),J())})),a.addEventListener("click",(function(e){const t=e.target.closest(".clear-input-btn");if(!t)return;const o=t.dataset.targetInput;if(!o)return void console.warn("Clear button clicked, but no target input ID found.");const n=document.getElementById(o);if(!n)return void console.warn(`Clear button clicked, but target input '#${o}' not found.`);const a=n.name;if(!a||void 0===T[a])return void console.warn(`Could not find default value for input '${a}'. Cannot reset.`);const s=T[a];"checkbox"===n.type?n.checked=s:n.value=s,oe(n),console.log(`Input '${a}' reset to default value:`,s)})),s.addEventListener("change",(e=>X(e,"marketing"))),l.addEventListener("change",(e=>X(e,"sms"))),m.addEventListener("click",W),d.addEventListener("keydown",(function(e){"Enter"===e.key&&(e.preventDefault(),W())})),y.addEventListener("input",ne),h.addEventListener("input",ne),y.addEventListener("blur",(function(e){const t=e.target;let o=parseInt(t.value,10);(isNaN(o)||o<=0)&&(t.value="140",oe(t))})),h.addEventListener("blur",(function(e){const t=e.target,o=parseInt(t.min,10)||1,n=parseInt(t.max,10)||20;let a=parseInt(t.value,10);(isNaN(a)||a<o||a>n)&&(t.value="1",oe(t))})),t.addEventListener("click",(function(e){const t=e.target.closest(".copy-msg-btn");if(!t)return;const o=t.closest(".message.ai");if(!o||!o.dataset.rawText)return void console.error("Could not find message text to copy.");const n=o.dataset.rawText;navigator.clipboard.writeText(n).then((()=>{t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022z"/></svg>',t.classList.add("copied"),t.disabled=!0,setTimeout((()=>{t.innerHTML=q,t.classList.remove("copied"),t.disabled=!1}),1500)})).catch((e=>{console.error("Failed to copy text: ",e),t.title="Copy failed!",setTimeout((()=>{t.title="Copy message"}),2e3)}))})),b.addEventListener("click",(function(){const e=t.querySelectorAll(".message.ai");if(0===e.length)return void z("ai","No AI messages to download.",!0);let o=`AI Generated Content (${N.toUpperCase()})\n=============================\n\n`,n=0;if(e.forEach(((e,t)=>{if(e.textContent.startsWith("Welcome to"))return;if(e.textContent.includes("API Key validated"))return;n++;const a=e.dataset.rawText||e.textContent;a.includes("Subject:")&&a.includes("Message:")?o+=`Email ${n}:\n${a}\n\n---\n\n`:a.includes("Variation")?o+=`${a}\n\n---\n\n`:o+=`SMS ${n}:\n${a}\n\n---\n\n`})),0===n)return void z("ai","No actual AI messages found to download (excluding welcome/status messages).",!0);const a=new Blob([o],{type:"text/plain;charset=utf-8"}),s=URL.createObjectURL(a),l=document.createElement("a");l.href=s;const r=(new Date).toISOString().replace(/[:.]/g,"-");l.download=`${N}_history_${r}.txt`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(s),console.log("AI message history download triggered.")})),w?w.addEventListener("change",(e=>{"mode"===e.target.name&&function(e){if(e===N)return;console.log(`Switching mode from ${N} to ${e}`);const o=`${P}${N}`,n=`${P}${e}`;localStorage.setItem(o,t.innerHTML),N=e,document.body.classList.remove("mode-sms-active","mode-email-active"),document.body.classList.add(`mode-${N}-active`);const a=localStorage.getItem(n);if(a)t.innerHTML=a;else{t.innerHTML="";const e=document.createElement("div");e.classList.add("message","ai","alert","alert-info"),e.setAttribute("role","alert"),e.textContent=`Welcome to ${"sms"===N?"SMS":"Email"} mode! Select a project and type your request below, or use the settings on the right.`,t.appendChild(e)}t.scrollTop=t.scrollHeight,localStorage.setItem(M,N),Y(),ee(),console.log(`Mode switched to ${N}. History loaded/cleared.`)}(e.target.value)})):console.error("Mode selector element not found!"),async function(){if(console.log("Initializing application..."),A=localStorage.getItem(j),A?console.log("Found API Key in localStorage."):(console.log("API Key not found in localStorage."),V()),function(){try{const n=localStorage.getItem(B);n&&(e.value=n);const a=localStorage.getItem(M);N=a||"sms","email"===N?E.checked=!0:I.checked=!0;const s=`${P}${N}`,l=localStorage.getItem(s);if(l)t.innerHTML=l,t.scrollTop=t.scrollHeight;else{t.innerHTML="";const e=document.createElement("div");e.classList.add("message","ai","alert","alert-info"),e.setAttribute("role","alert"),e.textContent=`Welcome to ${"sms"===N?"SMS":"Email"} mode! Select a project and type your request below, or use the settings on the right.`,t.appendChild(e)}const c=localStorage.getItem(_),d=localStorage.getItem(_+"_class");c&&(r.textContent=c,r.className=d||"file-status small text-muted");const m=localStorage.getItem(H),u=localStorage.getItem(H+"_class");m&&(i.textContent=m,i.className=u||"file-status small text-muted"),L="",x="";const g=localStorage.getItem(K);g&&(o.value=g,te()),console.log("State loaded from localStorage.")}catch(e){console.error("Error loading state from localStorage:",e),z("ai","Warning: Could not load saved application state.",!0),localStorage.removeItem(B),localStorage.removeItem(M),localStorage.removeItem(`${P}sms`),localStorage.removeItem(`${P}email`),localStorage.removeItem(_),localStorage.removeItem(_+"_class"),localStorage.removeItem(H),localStorage.removeItem(H+"_class"),localStorage.removeItem(K)}}(),document.body.classList.remove("mode-sms-active","mode-email-active"),document.body.classList.add(`mode-${N}-active`),Y(),ee(),te(),A){const e=t.querySelector(".message.ai");if(!e||!e.textContent.startsWith("Welcome to")){const e=t.querySelectorAll(".message.ai");let o=!1;e.forEach((e=>{e.textContent.includes("Ready to generate")&&(o=!0)})),o||z("ai",`Using stored API Key. Ready to generate in ${N} mode.`)}}console.log(`Application initialized in ${N} mode.`)}()}));