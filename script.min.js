document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("project"),t=document.getElementById("chat-display"),n=document.getElementById("user-input"),o=document.getElementById("send-button"),a=document.getElementById("settings-form"),s=document.getElementById("marketing-file"),r=document.getElementById("sms-file"),l=document.getElementById("marketing-file-status"),i=document.getElementById("sms-file-status"),c=document.getElementById("api-key-modal"),d=document.getElementById("modal-api-key-input"),u=document.getElementById("validate-key-button"),m=document.getElementById("modal-error-message"),g=document.getElementById("clear-project-button"),f=document.getElementById("clear-history-button"),p=document.getElementById("clear-settings-button"),y=document.getElementById("clear-files-button-left"),v=document.getElementById("length"),h=document.getElementById("num-results"),I=document.getElementById("download-history-button"),E=new bootstrap.Modal(c,{backdrop:"static",keyboard:!1});let b="",k="",S=!1,w=null,C={};const x="userApiKey",L="smsGenProject",A="smsGenHistory",B="smsGenMarketingFileStatus",T="smsGenSmsFileStatus",N="smsGenUserInput",P="BLAKE123",M="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3000":"https://sms-backend-generator.onrender.com",_=`${M}/api/generate`,$=`${M}/api/validate-key`;console.log("Using Backend Base URL:",M);const U='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>';async function K(e,t){if("DEV_SALT_REPLACE_IN_BUILD"===t&&console.warn("Calculating hash with default development salt."),!e||!t)return console.error("Cannot calculate hash: API key or salt is missing."),null;const n=e+t,o=(new TextEncoder).encode(n),a=await crypto.subtle.digest("SHA-256",o);return Array.from(new Uint8Array(a)).map((e=>e.toString(16).padStart(2,"0"))).join("")}function D(){m.textContent="",m.style.display="none",d.value="",E.show(),c.addEventListener("shown.bs.modal",(()=>d.focus()),{once:!0})}function H(){E.hide()}async function j(){const e=d.value.trim();if(!e)return m.textContent="Please enter an API key.",void(m.style.display="block");const t=e.toUpperCase();if("DEBUG"===t)return console.log("DEBUG keyword entered. Hiding modal."),void H();m.textContent="Validating...",m.style.display="block",u.disabled=!0;try{const e=await K(t,P);if(!e)return m.textContent="Configuration error (salt). Cannot validate key.",m.style.display="block",void(u.disabled=!1);const n=await fetch($,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":t,"X-Frontend-Secret":e}});if(n.ok)localStorage.setItem(x,t),w=t,m.textContent="",m.style.display="none",console.log("API Key validated and saved (uppercase)."),H(),F("ai","API Key validated and saved successfully.");else{if(403===n.status)m.textContent="Access Denied. Please ensure you are accessing from an allowed location and the key is correct.";else if(401===n.status)m.textContent="Invalid API Key provided.";else{const e=await n.json().catch((()=>({})));m.textContent=`Validation Error: ${e.error||n.statusText}`}m.style.display="block",console.warn("API Key validation failed:",n.status)}}catch(e){console.error("Error validating API key:",e),m.textContent="Network error during validation. Please try again.",m.style.display="block"}finally{u.disabled=!1}}function F(e,n,o=!1){if(!t)return console.error("addMessageToChat failed: chatDisplay element not found!"),void alert("Critical Error: Chat display area is missing. Please reload the page.");const a=document.createElement("div");if(a.classList.add("message",e),a.dataset.rawText=n,"ai"===e){a.classList.add("alert",o?"alert-danger":"alert-info"),a.setAttribute("role","alert");const e=document.createElement("button");e.type="button",e.classList.add("btn","btn-sm","copy-msg-btn"),e.title="Copy message",e.innerHTML=U;const t=document.createTextNode(n);a.appendChild(t),a.appendChild(e)}else{const e=document.createTextNode(n);a.appendChild(e)}o&&"ai"!==e&&a.classList.add("error"),t.insertAdjacentElement("beforeend",a),t.scrollTop=t.scrollHeight,q()}function G(e,t){const n=e.target.files[0],o="marketing"===t?l:i;if(n){const e=new FileReader;e.onload=e=>{const a=e.target.result;"marketing"===t?(b=a,console.log(`Marketing data loaded (${(a.length/1024).toFixed(2)} KB).`)):(k=a,console.log(`SMS data loaded (${(a.length/1024).toFixed(2)} KB).`)),o.textContent=`Loaded: ${n.name}`,o.className="file-status small text-muted loaded",q()},e.onerror=e=>{console.error("File reading error:",e),"marketing"===t?b="":k="",o.textContent=`Error reading ${n.name}`,o.className="file-status small text-danger error",F("ai",`Error reading file ${n.name}`,!0),q()},e.readAsText(n)}else"marketing"===t?b="":k="",o.textContent="No file selected",o.className="file-status small text-muted",q()}function R(){if(S)return;const s=n.value.trim();if(!s)return;if(!w)return F("ai","Error: API Key not set or validated. Please enter your key.",!0),void D();F("user",s),n.value="",z(),q();!async function(e,n){if(!w)return F("ai","Internal Error: API Key missing before sending request.",!0),void D();S=!0,o.disabled=!0,o.title="Generating...";const a=document.createElement("div");if(a.classList.add("message","ai","alert","alert-secondary"),a.setAttribute("role","status"),a.innerHTML='<span class="spinner-border spinner-border-sm" aria-hidden="true"></span><span class="ms-2">Generating...</span>',t.appendChild(a),t.scrollTop=t.scrollHeight,void 0===n.num_results){const t=e.match(/\d+/);if(t){const e=parseInt(t[0],10);!isNaN(e)&&e>=1&&e<=20?(n.num_results=e,console.log(`Extracted num_results (${e}) from prompt.`)):console.log(`Number found in prompt (${t[0]}) is outside valid range (1-20). Ignoring.`)}}try{const s=await K(w,P);if(!s)return F("ai","Configuration error (salt). Cannot generate signature.",!0),S=!1,o.disabled=!1,void t.removeChild(a);console.log("Sending request to backend:",_),console.log("Settings being sent:",n);const r=await fetch(_,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":w,"X-Frontend-Secret":s},body:JSON.stringify({userPrompt:e,settings:n,marketingData:b,smsData:k})});if(t.removeChild(a),!r.ok){let e=`Error: ${r.status} ${r.statusText}`;try{const t=await r.json();t&&t.error&&(401===r.status?(e="Error: Invalid or unauthorized API Key. Please refresh the page. If the problem persists, contact the administrator.",localStorage.removeItem(x),w=null,D()):e=403===r.status?`Error: Access Denied. (${t.error||"Please ensure you are accessing from an allowed location."})`:`Error: ${t.error}`)}catch(e){}return console.error("Backend request failed:",e),void F("ai",e,!0)}const l=await r.json();l.text?(console.log("Received response from backend."),F("ai",l.text)):l.error?(console.error("Backend returned an error:",l.error),F("ai",`Error: ${l.error}`,!0)):(console.error("Unexpected response format from backend:",l),F("ai","Received an unexpected response format from the server.",!0))}catch(e){console.error("Network or fetch error:",e);const n=t.querySelector('.alert-secondary[role="status"]');n&&t.removeChild(n),F("ai",`Network error: Could not reach the backend. Is it running? (${e.message})`,!0)}finally{S=!1,o.disabled=!1,o.title="Send Message (Ctrl+Enter)"}}(s,function(){const t=new FormData(a),n={};for(const[e,o]of t.entries()){if("marketing_file"===e||"sms_file"===e||"user_api_key"===e||"modal_api_key_input"===e)continue;const t=a.elements[e];"use_emojis"===e?t&&t.classList&&t.classList.contains("input-active-glow")?n[e]=t.checked:n[e]=!0:t&&t.classList&&t.classList.contains("input-active-glow")&&o&&(n[e]=o)}return n.project=e.value,n}())}function q(){try{localStorage.setItem(L,e.value),localStorage.setItem(A,t.innerHTML),localStorage.setItem(B,l.textContent),localStorage.setItem(T,i.textContent),localStorage.setItem(B+"_class",l.className),localStorage.setItem(T+"_class",i.className),localStorage.setItem(N,n.value)}catch(e){console.error("Error saving state to localStorage:",e),F("ai","Warning: Could not save application state. LocalStorage might be full or disabled.",!0)}}function V(e){const t="input-active-glow";if(!e||!e.name||"file"===e.type||"hidden"===e.type||"BUTTON"===e.tagName)return;let n=!0;const o=C[e.name];if("checkbox"===e.type)n=e.checked===o;else{n=(e.value||"")===(o||"")}n?e.classList.remove(t):e.classList.add(t)}function O(){console.log("Updating glows for all settings inputs based on defaults.");for(const e of a.elements)V(e)}function z(){n.style.height="auto",n.style.height=n.scrollHeight+"px"}function W(e){const t=e.target.value,n=t.replace(/\D/g,"");t!==n&&(e.target.value=n)}function X(e){const t=new Event("input",{bubbles:!0,cancelable:!0});e.dispatchEvent(t)}o.addEventListener("click",R),a.addEventListener("input",(e=>{V(e.target),q()})),e.addEventListener("change",q),n.addEventListener("input",(()=>{z(),q()})),g.addEventListener("click",(function(){e.selectedIndex=0,localStorage.removeItem(L),console.log("Project selection cleared."),q()})),f.addEventListener("click",(function(){const e=t.querySelector(".message.ai.alert-info");if(t.innerHTML="",e)t.appendChild(e);else{const e=document.createElement("div");e.classList.add("message","ai","alert","alert-info"),e.setAttribute("role","alert"),e.textContent="Welcome! Ask me to generate SMS copy, or use the settings on the right and type your request below. Upload files via the settings panel.",t.appendChild(e)}localStorage.removeItem(A),console.log("Chat history cleared."),q()})),p.addEventListener("click",(function(){a.reset(),console.log("Settings cleared."),O()})),y.addEventListener("click",(function(){s.value="",r.value="",b="",k="",l.textContent="No file selected",i.textContent="No file selected",l.className="file-status small text-muted",i.className="file-status small text-muted",console.log("File selections and data cleared."),q()})),n.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),R())})),a.addEventListener("click",(function(e){const t=e.target.closest(".clear-input-btn");if(!t)return;const n=t.dataset.targetInput;if(!n)return void console.warn("Clear button clicked, but no target input ID found.");const o=document.getElementById(n);if(!o)return void console.warn(`Clear button clicked, but target input '#${n}' not found.`);const a=o.name;if(!a||void 0===C[a])return void console.warn(`Could not find default value for input '${a}'. Cannot reset.`);const s=C[a];"checkbox"===o.type?o.checked=s:o.value=s,X(o),console.log(`Input '${a}' reset to default value:`,s)})),s.addEventListener("change",(e=>G(e,"marketing"))),r.addEventListener("change",(e=>G(e,"sms"))),n.addEventListener("input",z),u.addEventListener("click",j),d.addEventListener("keydown",(function(e){"Enter"===e.key&&(e.preventDefault(),j())})),v.addEventListener("input",W),h.addEventListener("input",W),v.addEventListener("blur",(function(e){const t=e.target;let n=parseInt(t.value,10);(isNaN(n)||n<=0)&&(t.value="140",X(t))})),h.addEventListener("blur",(function(e){const t=e.target,n=parseInt(t.min,10)||1,o=parseInt(t.max,10)||20;let a=parseInt(t.value,10);(isNaN(a)||a<n||a>o)&&(t.value="1",X(t))})),t.addEventListener("click",(function(e){const t=e.target.closest(".copy-msg-btn");if(!t)return;const n=t.closest(".message.ai");if(!n||!n.dataset.rawText)return void console.error("Could not find message text to copy.");const o=n.dataset.rawText;navigator.clipboard.writeText(o).then((()=>{t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022z"/></svg>',t.classList.add("copied"),t.disabled=!0,setTimeout((()=>{t.innerHTML=U,t.classList.remove("copied"),t.disabled=!1}),1500)})).catch((e=>{console.error("Failed to copy text: ",e),t.title="Copy failed!",setTimeout((()=>{t.title="Copy message"}),2e3)}))})),I.addEventListener("click",(function(){const e=t.querySelectorAll(".message.ai");if(0===e.length)return void F("ai","No AI messages to download.",!0);let n="AI Generated SMS Messages\n=============================\n\n";if(e.forEach(((e,t)=>{if(0===t&&e.textContent.startsWith("Welcome!"))return;const o=e.dataset.rawText||e.textContent;n+=`Message ${t+1}:\n${o}\n\n---\n\n`})),"AI Generated SMS Messages\n============================="===n.trim())return void F("ai","No actual AI messages found to download (excluding welcome).",!0);const o=new Blob([n],{type:"text/plain;charset=utf-8"}),a=URL.createObjectURL(o),s=document.createElement("a");s.href=a;const r=(new Date).toISOString().replace(/[:.]/g,"-");s.download=`sms_history_${r}.txt`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a),console.log("AI message history download triggered.")})),async function(){console.log("Initializing application..."),function(){console.log("Storing default settings values..."),C={};for(const e of a.elements)!e.name||"INPUT"!==e.tagName&&"SELECT"!==e.tagName&&"TEXTAREA"!==e.tagName||("checkbox"===e.type?C[e.name]=e.defaultChecked:C[e.name]=e.defaultValue||"")}(),w=localStorage.getItem(x),w?(console.log("Found API Key in localStorage. Validating..."),F("ai","Using stored API Key. Ready to generate.")):(console.log("API Key not found in localStorage."),D()),function(){try{const o=localStorage.getItem(L);o&&(e.value=o);const a=localStorage.getItem(A);if(a)t.innerHTML=a,t.scrollTop=t.scrollHeight;else if(!t.querySelector(".message")){const e=document.createElement("div");e.classList.add("message","ai","alert","alert-info"),e.setAttribute("role","alert"),e.textContent="Welcome! Ask me to generate SMS copy, or use the settings on the right and type your request below. Upload files via the settings panel.",t.appendChild(e)}const s=localStorage.getItem(B),r=localStorage.getItem(B+"_class");s&&(l.textContent=s,l.className=r||"file-status small text-muted");const c=localStorage.getItem(T),d=localStorage.getItem(T+"_class");c&&(i.textContent=c,i.className=d||"file-status small text-muted"),b="",k="";const u=localStorage.getItem(N);u&&(n.value=u,z()),console.log("State loaded from localStorage.")}catch(e){console.error("Error loading state from localStorage:",e),F("ai","Warning: Could not load saved application state.",!0),localStorage.removeItem(L),localStorage.removeItem(A),localStorage.removeItem(B),localStorage.removeItem(B+"_class"),localStorage.removeItem(T),localStorage.removeItem(T+"_class"),localStorage.removeItem(N)}}(),O(),z(),console.log("Application initialized.")}()}));